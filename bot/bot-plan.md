# План разработки модуля Telegram-бота для LaterListener

## Цель модуля
Создать Telegram-бота, который:
- Принимает аудиофайлы от пользователей.
- Принимает оплату через Telegram Stars (в рамках самого бота).
- Ставит задачу на транскрибацию в очередь.
- После завершения обработки отправляет пользователю ссылку на результат с временным токеном для авторизации.

---

## Основные шаги разработки (детализация)

### 1. Подготовка окружения и доступов
1. Получить токен Telegram-бота через [@BotFather](https://t.me/BotFather).
2. Настроить Telegram Stars для приема платежей (подключить в настройках бота).
3. Настроить очередь задач (Celery + брокер сообщений: Redis или RabbitMQ).
4. Настроить сервис транскрибации (Whisper/pyannote) и его API.
5. Настроить базу данных (PostgreSQL) для хранения пользователей, задач, транскрипций.
6. Настроить сервис для генерации ссылок и временных токенов.
7. Описать и задокументировать все переменные окружения и секреты.

### 2. Проектирование архитектуры и сценариев
1. Описать user flow:
   - Старт/приветствие.
   - Получение аудиофайла.
   - Проверка оплаты через Telegram Stars.
   - Подтверждение оплаты.
   - Постановка задачи в очередь.
   - Оповещение о статусе (ожидание, прогресс, готово).
   - Отправка ссылки на результат.
2. Описать структуру хранения данных (модели: User, Task, Payment, Transcript).
3. Определить API взаимодействия с очередью и сервисом транскрибации.

### 3. Реализация функций (разбивка на подзадачи)
#### 3.1. Инициализация и базовые команды
- Настроить aiogram и создать объект бота.
- Реализовать обработку команд /start, /help, /status.
- Реализовать хранение и обновление информации о пользователях.

#### 3.2. Приём и валидация аудиофайлов
- Реализовать обработчик сообщений с аудиофайлом/voice/note.
- Проверять формат и размер файла (ограничения Telegram).
- Сохранять файл во временное хранилище.

#### 3.3. Интеграция оплаты через Telegram Stars
- Отправлять пользователю запрос на оплату через Telegram Stars.
- Отслеживать статус оплаты (webhook/callback).
- Обрабатывать успешную и неуспешную оплату.
- Сохранять информацию о платеже в БД.

#### 3.4. Постановка задачи в очередь транскрибации
- Формировать задачу (user_id, file_id, параметры).
- Отправлять задачу в очередь Celery.
- Сохранять статус задачи в БД.

#### 3.5. Ожидание и обработка результата
- Получать уведомление о завершении задачи (callback/пуллинг).
- Сохранять результат транскрибации в БД.
- Генерировать временный токен и ссылку на результат.
- Отправлять ссылку пользователю.

#### 3.6. Логирование и обработка ошибок
- Логировать все ключевые действия и ошибки.
- Реализовать обработку нештатных ситуаций (сбой оплаты, сбой транскрибации, превышение лимитов и т.д.).

### 4. Интеграция с внешними сервисами
- Celery: постановка и отслеживание задач.
- Whisper/pyannote: API для передачи аудиофайлов и получения результата.
- Веб-сервис: генерация и валидация временных токенов.
- PostgreSQL: хранение пользователей, задач, транскрипций, токенов.

### 5. Тестирование
- Покрыть юнит-тестами все обработчики и бизнес-логику.
- Провести интеграционное тестирование взаимодействия с очередью, транскрибацией и оплатой.
- Провести end-to-end тестирование сценариев пользователя.

### 6. Документация
- Описать все эндпоинты и сценарии работы бота.
- Подготовить инструкцию по развертыванию и настройке окружения.
- Описать переменные окружения и секреты.
- Привести примеры взаимодействия с ботом (user flow).

### 7. Деплой и поддержка
- Настроить CI/CD для автоматического деплоя (GitHub Actions).
- Настроить мониторинг и логирование.
- Регулярно обновлять зависимости и поддерживать безопасность.

---

## Взаимосвязи Telegram-бота с другими модулями

СДЕЛАТЬ

---

## Диаграмма последовательности (Sequence Diagram)

Представлена в файле ```bot/sequence_diagram_bot.md```

---

## Необходимые зависимости для интеграции

- **aiogram** — для работы с Telegram Bot API
- **Celery** — для очереди задач
- **Redis/RabbitMQ** — брокер сообщений для Celery
- **PostgreSQL** — база данных для хранения пользователей, задач, транскрипций
- **HTTP-клиент** (например, httpx/requests) — для интеграции с внешними сервисами (транскрибация, веб)
- **Telegram Stars** — встроенная оплата через Telegram
- **Сервис транскрибации** — API для передачи аудиофайлов и получения текста
- **Веб-сервис** — для генерации и валидации временных токенов и ссылок
- **Docker** — для контейнеризации и деплоя
- **Логирование и мониторинг** — для отслеживания работы и ошибок
